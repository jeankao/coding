{% extends "base.html" %}
{% load tag %}
{% block header %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/static/starrr/starrr.css">
<script type="text/javascript" src="/static/starrr/starrr.js"></script>
{% endblock %}

{% block content %}
<table class="table">
  <tr>
    <td>學生</td>
    <td>組別</td>
    <td>功能</td>
  </tr>
  {% for list in classmate_work %}
  <tr>
    <td>{{list.0.seat}}){{list.0.student.first_name}}</td>
    <td>{{list.2}}</td>
    <td class="rating-wrapper" data-stuid="{{ list.0.student_id }}" data-workid="{% if list.1.id %}{{ list.1.id }}{% else %}0{% endif %}">
      <div class="starrr readonly" data-rating="{{ list.1.score }}"></div>    
      <button class="btn btn-sm rating-student">個人評分</button>      
      <button class="btn btn-sm btn-danger clear-btn">清除</button>        
      <button class="btn btn-sm rating-group">小組評分</button>         
    </td>
  </tr>
  {% endfor %}
</table>
{% endblock %}

{% block domready %}
  $('.starrr.readonly').starrr({
    readOnly: true,
  });

  var btn_class_rating_student = 'btn-outline-dark', 
      btn_class_cancel_student = 'btn-outline-danger';

  function do_rating(e, value) {
    var $this = $(e.target), 
        $parent = $this.parent(),
        $ratingObj = $('.starrr.edit', $parent),
        $origObj = $('.starrr.readonly', $parent),
        $ratingBtn = $('button.rating-student', $parent),
        $clearBtn = $('button.clear-btn', $parent),
        origValue = $origObj.data('rating');

    if (value === undefined)
      value = origValue;
    
    if (value !== origValue) {
      $.post('/teacher/work3/score/{{classroom.lesson}}/{{classroom.id}}/{{index}}/', {
        workid: $parent.data('workid'),
        stuid: $parent.data('stuid'),
        score: value,
      }, function(data){
        $parent.data('workid', data.workid);
        $origObj.data({starrr: null, rating: value}).empty().starrr({readOnly: true});
      });
    }
    $ratingBtn.removeClass(btn_class_cancel_student).addClass(btn_class_rating_student).text('個人評分');
    $clearBtn.removeClass('show');
    $ratingObj.remove();
  }

  $('.rating-student').addClass(btn_class_rating_student).click(function() {
    var $parent = $(this).parent().append('<div class="starrr edit"></div>'), 
        $ratingObj = $('.starrr.edit', $parent),
        $origObj = $('.starrr.readonly', $parent),
        $ratingBtn = $('button.rating-student', $parent),
        $clearBtn = $('button.clear-btn', $parent);
    if (!$ratingBtn.hasClass(btn_class_cancel_student)) {
      $ratingBtn.addClass(btn_class_cancel_student).removeClass(btn_class_rating_student).text('取消評分');
      if ($origObj.data('rating'))
        $clearBtn.addClass('show');
      $ratingObj.offset($origObj.offset()).starrr({
        rating: $origObj.data('rating'), 
        change: do_rating,
      });
    } else {
      $ratingBtn.removeClass(btn_class_cancel_student).addClass(btn_class_rating_student).text('個人評分');
      $clearBtn.removeClass('show');
      $ratingObj.remove();
    }
  });

  $('.clear-btn').click(function(e) {
    do_rating(e, 0);
  });
{% endblock %}