{% extends "base.html" %}
{% load tag %}
{% block header %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/static/starrr/starrr.css">
<script type="text/javascript" src="/static/starrr/starrr.js"></script>
{% endblock %}

{% block content %}
<table class="table">
  <tr>
    <td>學生</td>
    <td>組別</td>
    <td>功能</td>
  </tr>
  {% for list in classmate_work %}
  <tr>
    <td>{{list.0.seat}}){{list.0.student.first_name}}</td>
    <td>{{list.2}}</td>
    <td class="pos-relative" data-stuid="{{ list.0.student_id }}" data-workid="{% if list.1.id %}{{ list.1.id }}{% else %}0{% endif %}">
      <div class="starrr readonly" data-rating="{{ list.1.score }}"></div>
      <button class="btn btn-sm rating-btn">評分</button>
    </td>
  </tr>
  {% endfor %}
</table>
{% endblock %}

{% block domready %}
  $('.starrr.readonly').starrr({
    readOnly: true,
  });

  var btn_class_rating = 'btn-outline-dark', 
      btn_class_cancel = 'btn-outline-danger';

  $('.rating-btn').addClass(btn_class_rating).click(function() {
    $(this).parent().append('<div class="starrr edit"></div>');
    var $ratingObj = $('.starrr.edit', $(this).parent());
    var $origObj = $('.starrr.readonly', $(this).parent());
    var $btnObj = $('button.rating-btn', $(this).parent());
    var origValue = $origObj.data('rating');
    if (!$btnObj.hasClass(btn_class_cancel)) {
      $btnObj.addClass(btn_class_cancel).removeClass(btn_class_rating).text('取消');
      $ratingObj.offset($origObj.offset());
      $ratingObj.starrr({
        rating: $origObj.data('rating'), 
        change: function(e, value) {
          var $this = $(this);
          var $parent = $this.parent();
          if (value === undefined)
            value = origValue;
          $.post('/teacher/work3/score/{{classroom.lesson}}/{{classroom.id}}/{{index}}/', {
            workid: $parent.data('workid'),
            stuid: $parent.data('stuid'),
            score: value,
          }, function(data){
            if (!$parent.data('workid')) 
              $parent.data('workid', data.workid);
          });
          $origObj.data({starrr: null, rating: value}).empty().starrr({readOnly: true});
          $btnObj.removeClass(btn_class_cancel).addClass(btn_class_rating).text('評分');
          $this.remove();
        },
      });
    } else {
      $btnObj.removeClass(btn_class_cancel).addClass(btn_class_rating).text('評分');
      $('.starrr.edit', $(this).parent()).remove();
    }
  });
{% endblock %}